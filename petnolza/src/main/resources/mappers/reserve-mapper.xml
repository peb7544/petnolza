<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.pet.reserve.model.mapper.ReserveMapper">
 	
 	<!-- 객실 예약 목록 조회 -->
 	<select id="selectReserveList">
 		SELECT 
			 ROOM_ID
			,ROOM_NAME
			,ROOM_PRICE
			,CODE_NAME CODE_NAME_LIST
			,REVIEW_GRADE
		FROM (
		SELECT 
			 R.ROOM_ID 
			,ROOM_NAME 
			,ROOM_PRICE
			,(SELECT 
					SUBSTR(
				        XMLAGG(
				            XMLELEMENT(COL ,',', CODE_NAME) ORDER BY ORDERBY).EXTRACT('//text()'
				        ).GETSTRINGVAL()
				  , 2) CODE_NAME
				FROM ROOM_INFO RINFO
				JOIN CODE_MT USING(CODE_NO)
				WHERE RINFO.ROOM_ID = R.ROOM_ID
				AND RINFO.GROUP_CODE = 'CONV' ) CODE_NAME
			,(SELECT 
					ROUND(AVG(REVIEW_GRADE))  
			  FROM REVIEW RE
		    WHERE RE.ROOM_ID = R.ROOM_ID) REVIEW_GRADE
		  ,RESERVE_START
		  ,RESERVE_END
		FROM ROOM R
		LEFT OUTER JOIN RESERVE RES ON R.ROOM_ID = RES.ROOM_ID
		WHERE 1=1
		) Z
		WHERE 1=1
		GROUP BY ROOM_ID
						,ROOM_NAME
						,ROOM_PRICE
						,CODE_NAME
						,REVIEW_GRADE
		ORDER BY ROOM_ID
 	</select>
 	
 	<!-- 객실 예약 검색 조회 -->
 	<select id="searchReserveList">
 		SELECT 
			 ROOM_ID
			,ROOM_NAME
			,ROOM_PRICE
			,CODE_NAME
			,REVIEW_GRADE
		FROM (
		SELECT 
			 R.ROOM_ID 
			,ROOM_NAME 
			,ROOM_PRICE
			,(SELECT 
					SUBSTR(
				        XMLAGG(
				            XMLELEMENT(COL ,',', CODE_NAME) ORDER BY ORDERBY).EXTRACT('//text()'
				        ).GETSTRINGVAL()
				  , 2) CODE_NAME
				FROM ROOM_INFO RINFO
				JOIN CODE_MT USING(CODE_NO)
				WHERE RINFO.ROOM_ID = R.ROOM_ID
				AND RINFO.GROUP_CODE = 'CONV' ) CODE_NAME
			,(SELECT 
					ROUND(AVG(REVIEW_GRADE))  
			  FROM REVIEW RE
		    WHERE RE.ROOM_ID = R.ROOM_ID) REVIEW_GRADE
		  ,RESERVE_START
		  ,RESERVE_END
		FROM ROOM R
		LEFT OUTER JOIN RESERVE RES ON R.ROOM_ID = RES.ROOM_ID
		WHERE (((NOT RESERVE_START BETWEEN '20240510' AND '20240516')
						AND (NOT RESERVE_END BETWEEN '20240510' AND '20240516'))
					 OR RESERVE_START IS NULL
					 OR RESERVE_END IS NULL
					)
		) Z
		WHERE ROOM_NAME LIKE '%' || '객' || '%'
		GROUP BY ROOM_ID
						,ROOM_NAME
						,ROOM_PRICE
						,CODE_NAME
						,REVIEW_GRADE
		ORDER BY ROOM_ID
 	</select>
</mapper>
