<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.pet.reserve.model.mapper.ReserveMapper">
 	
 	<!-- 객실 예약 목록 조회 -->
 	<select id="selectReserveList">
 		SELECT 
			 ROOM_ID
			,ROOM_NAME
			,ROOM_PRICE
			,CODE_NAME CODE_NAME_LIST
			,REVIEW_GRADE
			,FILE_RENAME
		FROM (
		SELECT 
			 R.ROOM_ID 
			,ROOM_NAME 
			,ROOM_PRICE
			,(SELECT 
					SUBSTR(
				        XMLAGG(
				            XMLELEMENT(COL ,',', CODE_NAME) ORDER BY ORDERBY).EXTRACT('//text()'
				        ).GETSTRINGVAL()
				  , 2) CODE_NAME
				FROM ROOM_INFO RINFO
				JOIN CODE_MT USING(CODE_NO)
				WHERE RINFO.ROOM_ID = R.ROOM_ID
				AND RINFO.GROUP_CODE = 'CONV' ) CODE_NAME
			,(SELECT 
					ROUND(AVG(REVIEW_GRADE))  
			  FROM REVIEW RE
		    WHERE RE.ROOM_ID = R.ROOM_ID) REVIEW_GRADE
		  ,RESERVE_START
		  ,RESERVE_END
		  ,UF.FILE_PATH || UF.FILE_RENAME FILE_RENAME
		FROM ROOM R
		LEFT OUTER JOIN RESERVE RES ON R.ROOM_ID = RES.ROOM_ID
		LEFT OUTER JOIN UPLOAD_FILE UF ON R.ROOM_ID = UF.TABLE_NO AND UF.TABLE_NAME = 'ROOM' AND UF.THUMBNAIL = 'Y'
		WHERE 1=1
		 <if test='inputStart != null  and inputEnd != null'>
		 AND (((NOT RESERVE_START BETWEEN #{inputStart} AND #{inputEnd})
						AND (NOT RESERVE_END BETWEEN #{inputStart} AND #{inputEnd}))
					 OR RESERVE_START IS NULL
					 OR RESERVE_END IS NULL
					)	
		 </if>
		) Z
		WHERE 1=1
		<if test='inputRoomNm != null'>
		AND ROOM_NAME LIKE '%' || #{inputRoomNm} || '%'
		</if>
		GROUP BY ROOM_ID
				,ROOM_NAME
				,ROOM_PRICE
				,CODE_NAME
				,REVIEW_GRADE
				,FILE_RENAME
		ORDER BY ROOM_ID
 	</select>
</mapper>
